<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>[Edit] RFC Trans</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <link rel="stylesheet" href="master.css">

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>
<body>
  <div class="download" style="position: sticky; top: 0px;">
    <button id="download_json" type="button" class="btn btn-primary">json</button>
    <a id="download_anchor_elem"></a>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-sm-12 col-md-12">
        <div class="alert alert-info" role="alert">
          <h4 class="alert-heading"><span id="title_text"></span> 日本語訳</h4>
          タイトル :
          <strong><span id="title_ja" contenteditable="true"></span></strong><br>
          RFC番号 :
          <span id="number" contenteditable="true"></span><br>
          作成日時 :
          <span id="created_at" contenteditable="true"></span><br>
          翻訳編集 :
          <span id="updated_by" contenteditable="true"></span><br>
        </div>
      </div>
    </div>

    <div id="content" contenteditable="true"></div>
  </div>

  <script>
    var url = new URL(window.location.href);
    var rfc_number = parseInt(url.searchParams.get("rfc"));

    // var rfc_number = 1149;
    var d4 = Math.floor(rfc_number/1000)%10;
    var d3 = Math.floor(rfc_number/100)%10;
    var filepath = "../data/" + d4 + "000/" + d3 + "00/rfc" + rfc_number + "-trans.json";
    $.getJSON(filepath, function (data) {
      console.log(data);
      $('#title_text').text(data.title.text);
      $('#title_ja').text(data.title.ja);
      $('#number').text(data.number);
      $('#created_at').text(data.created_at);
      $('#updated_by').text(data.updated_by);

      for (var i = 0; i < data.contents.length; i++) {
        var ctx = data.contents[i];

        if (ctx.raw === true) {
          $('#content').append(
            $('<div class="row mode_raw">')
            .append(
              $('<div class="col-sm-12 indent small">').text(ctx.indent)
            )
            .append(
              $('<div class="col-sm-12 col-md-12">').append(
                $('<pre class="text text-monospace">').text(ctx.text)
              )
            )
          );
        } else if (ctx.section_title === true) {
          $('#content').append(
            $('<div class="row mode_section">')
            .append(
              $('<div class="col-sm-12 indent small">').text(ctx.indent)
            )
            .append(
              $('<div class="col-sm-12 col-md-6">').append(
                $('<h5 class="text mt-2">').text(ctx.text)
              )
            )
            .append(
              $('<div class="col-sm-12 col-md-6">').append(
                $('<h5 class="text mt-2">').text(ctx.ja)
              )
            )
          );
        } else {
          $('#content').append(
            $('<div class="row mode_text">')
            .append(
              $('<div class="col-sm-12 indent small">').text(ctx.indent)
            )
            .append(
              $('<div class="col-sm-12 col-md-6">').append(
                $('<p class="text">').text(ctx.text)
              )
            )
            .append(
              $('<div class="col-sm-12 col-md-6">').append(
                $('<p class="text">').text(ctx.ja)
              )
            )
          );
        }
      }
    });

    $('#download_json').on('click', function () {
      var data = {};
      data.title = {
        text: $('#title_text').text(),
        ja:   $('#title_ja').text()
      }
      data.number = parseInt($('#number').text());
      data.created_at = $('#created_at').text();
      data.updated_by = $('#updated_by').text();
      data.contents = [];

      contents = $('#content .row');
      console.log(contents);
      for (var i = 0; i < contents.length; i++) {
        var $ctx = $(contents[i]);
        console.log($ctx);

        if ($ctx.hasClass('mode_raw')) {
          var indent = parseInt($($ctx.find('.indent')[0]).text());
          var text = $($ctx.find('pre.text')[0]).text();
          data.contents.push({
            indent: indent, text: text, raw: true
          });
        }
        else if ($ctx.hasClass('mode_section')) {
          var indent = parseInt($($ctx.find('.indent')[0]).text());
          var text = $($ctx.find('h5.text')[0]).text();
          var ja   = $($ctx.find('h5.text')[1]).text();
          data.contents.push({
            indent: indent, text: text, section_title: true, ja: ja
          });
        }
        else if ($ctx.hasClass('mode_text')) {
          var indent = parseInt($($ctx.find('.indent')[0]).text());
          var text = $($ctx.find('p.text')[0]).text();
          var ja   = $($ctx.find('p.text')[1]).text();
          data.contents.push({
            indent: indent, text: text, ja: ja
          });
        }
      }

      console.log(data);

      var jsonData = JSON.stringify(data, null, '  ');
      var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonData);
      var dlAnchorElem = document.getElementById('download_anchor_elem');
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", "rfc" + data.number + "-trans.json");
      dlAnchorElem.click();
    });
  </script>
</body>
</html>
